# Zapier Triggers API

A serverless FastAPI backend for managing Zapier webhook triggers, built with AWS Amplify Gen 2, Lambda, and DynamoDB.

## Architecture

- **Backend**: FastAPI running on AWS Lambda with Lambda Web Adapter
- **Database**: DynamoDB for event storage with GSI for status queries
- **Secrets**: AWS Secrets Manager for secure credential storage
- **Infrastructure**: AWS Amplify Gen 2 with CDK for IaC
- **CI/CD**: Multi-environment deployment via AWS Amplify Console

## Multi-Environment Setup

This project uses a branch-based deployment strategy with two environments:

### Environments

- **Production** (`main` branch)
  - Stable, production-ready code
  - Deploy: Push to `main` branch
  - Stack name: Auto-generated by Amplify

- **Development** (`dev` branch)
  - Active development and testing
  - Deploy: Push to `dev` branch
  - Stack name: Auto-generated by Amplify

### Branch Strategy

```
main (production)
  └── dev (development)
```

### Deployment Workflow

1. **Development Changes**:
   ```bash
   git checkout dev
   # Make changes
   git add .
   git commit -m "feat: your feature"
   git push origin dev
   ```
   → Triggers automatic deployment to development environment

2. **Production Release**:
   ```bash
   git checkout main
   git merge dev
   git push origin main
   ```
   → Triggers automatic deployment to production environment

## AWS Amplify Console Setup

### Initial Setup

1. **Connect Repository**:
   - Go to AWS Amplify Console
   - Select "Host web app"
   - Connect your GitHub repository
   - Choose the repository: `metamonk/apier`

2. **Configure Branches**:
   - Add `main` branch → Production environment
   - Add `dev` branch → Development environment

3. **Build Settings**:
   - Amplify will auto-detect the `amplify.yml` configuration
   - Both branches use the same build configuration
   - Backend resources are automatically namespaced per environment

### Environment-Specific Resources

Each environment gets its own isolated AWS resources:

- DynamoDB Table: `zapier-triggers-events-{stackName}`
- Lambda Function: Auto-generated name by CDK
- Secrets Manager Secret: `zapier-api-credentials-{stackName}`
- Function URL: Unique per environment

### Accessing Environment URLs

After deployment, find your API URLs in:
- AWS Amplify Console → App → Branch → Backend resources → "TriggersApiUrl"
- Or via CloudFormation Outputs in the stack

## Local Development

### Prerequisites

- Node.js 18+
- AWS CLI configured with appropriate credentials
- Docker (for Lambda function builds)

### Setup

1. **Install Dependencies**:
   ```bash
   npm install
   ```

2. **Run Amplify Sandbox**:
   ```bash
   npx ampx sandbox
   ```
   This creates a personal development environment in AWS.

### Project Structure

```
apier/
├── amplify/                    # Amplify backend configuration
│   ├── backend.ts             # Main backend definition
│   ├── auth/                  # Cognito auth resources
│   ├── data/                  # AppSync/data resources
│   ├── functions/             # Lambda functions
│   │   └── api/              # FastAPI application
│   │       ├── Dockerfile    # Lambda container config
│   │       ├── main.py       # FastAPI app
│   │       └── requirements.txt
│   └── storage/              # Storage resources
├── amplify.yml               # Amplify build configuration
└── README.md                # This file
```

## API Endpoints

Base URL: `{FunctionURL}` (provided after deployment)

### Endpoints

- `GET /` - Health check
- `GET /docs` - Interactive API documentation (Swagger UI)
- `POST /events` - Create event
- `GET /events` - List events (with pagination)
- `GET /events/{id}` - Get specific event
- `PUT /events/{id}` - Update event
- `DELETE /events/{id}` - Delete event

### Authentication

Currently uses API key authentication stored in AWS Secrets Manager.

## Testing

The API includes comprehensive unit tests for all endpoints with 80%+ code coverage.

### Running Tests

```bash
# Install test dependencies
pnpm test:install

# Run all tests
pnpm test

# Run with coverage report
pnpm test:cov

# Run verbose output
pnpm test:verbose
```

### Test Coverage

- ✅ Health check endpoints (`/`, `/health`)
- ✅ Configuration endpoint (`/config`)
- ✅ Event creation (`POST /events`)
- ✅ Inbox retrieval (`GET /inbox`)
- ✅ Event acknowledgment (`POST /inbox/{id}/ack`)
- ✅ End-to-end workflows
- ✅ Error handling and validation

Tests use **moto** to mock AWS services (DynamoDB, Secrets Manager) for isolated, fast execution without AWS costs.

**See [TESTING.md](./TESTING.md) for detailed testing documentation.**

## Secrets Management

API credentials are stored in AWS Secrets Manager:

1. **View Secrets**:
   ```bash
   aws secretsmanager get-secret-value \
     --secret-id zapier-api-credentials-{stackName} \
     --query SecretString --output text | jq
   ```

2. **Update Secrets**:
   ```bash
   aws secretsmanager update-secret \
     --secret-id zapier-api-credentials-{stackName} \
     --secret-string '{
       "zapier_api_key": "your-key",
       "zapier_webhook_url": "https://hooks.zapier.com/...",
       "jwt_secret": "auto-generated",
       "environment": "production"
     }'
   ```

## Monitoring & Debugging

- **Lambda Logs**: CloudWatch Logs → Log Group → `/aws/lambda/{functionName}`
- **DynamoDB Metrics**: CloudWatch → DynamoDB → Table metrics
- **Amplify Build Logs**: Amplify Console → App → Branch → Build logs

## Infrastructure as Code

All infrastructure is defined in code within the `amplify/` directory:

- `backend.ts` - Main CDK stack definition
- Resources are version-controlled
- Changes are deployed via Git push
- No manual AWS Console configuration required

## Security

The API implements comprehensive security measures:

- ✅ **TLS/HTTPS Encryption**: All traffic encrypted (Lambda Function URLs are HTTPS-only)
- ✅ **JWT Bearer Token Authentication**: Stateless token-based authentication for API access
- ✅ **AWS Secrets Manager**: Secure storage of API keys and JWT secrets
- ✅ **IAM Role-Based Access**: Least privilege access to AWS resources
- ✅ **Password Hashing**: Argon2id for secure password storage

### Quick Start - Authentication

```bash
# 1. Get JWT token
curl -X POST "https://YOUR_FUNCTION_URL/token" \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "username=api&password=YOUR_API_KEY"

# 2. Use token for API requests
curl -X POST "https://YOUR_FUNCTION_URL/events" \
  -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"type": "event.type", "source": "app", "payload": {}}'
```

**See [SECURITY.md](./SECURITY.md) for comprehensive security documentation.**

## Troubleshooting

### Build Failures

1. Check Amplify Console build logs
2. Verify `amplify.yml` syntax
3. Ensure all dependencies are in `package.json`

### Deployment Issues

1. Check AWS credentials and permissions
2. Verify branch is correctly configured in Amplify Console
3. Check CloudFormation stack events for errors

### Lambda Function Errors

1. Check CloudWatch Logs for the Lambda function
2. Verify environment variables are set correctly
3. Test locally using `ampx sandbox`

## Contributing

1. Create feature branch from `dev`
2. Make changes and test locally with `ampx sandbox`
3. Push to feature branch and create PR to `dev`
4. After testing in dev environment, merge to `main` for production

## License

MIT
