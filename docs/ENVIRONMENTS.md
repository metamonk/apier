# Environment Guide

## Overview

The Zapier Triggers API uses a streamlined two-environment deployment strategy powered by AWS Amplify Gen 2's branch-based deployments:

- **Development (dev)**: Active feature development and testing
- **Production (main)**: Live API serving customer traffic

**Note**: As of November 14, 2025, we removed the sandbox environment to simplify the deployment workflow. All testing now occurs in the development environment before promotion to production.

## Architecture

### Branch Strategy

```
main (production) ← stable, production-ready code
  │
  └── dev (development) ← active development, testing
```

### Environment Configuration

| Attribute | Development (dev) | Production (main) |
|-----------|-------------------|-------------------|
| **Git Branch** | `dev` | `main` |
| **Amplify Stage** | `DEVELOPMENT` | `PRODUCTION` |
| **Amplify App ID** | `dmmfqlsr845yz` | `dmmfqlsr845yz` |
| **Region** | `us-east-2` (Ohio) | `us-east-2` (Ohio) |
| **Frontend URL** | https://dev.dmmfqlsr845yz.amplifyapp.com | https://main.dmmfqlsr845yz.amplifyapp.com |
| **Auto-Deploy** | ✅ Enabled | ✅ Enabled |

### Resource Isolation

Each environment gets its own isolated AWS resources:

| Resource | Naming Pattern | Example |
|----------|---------------|---------|
| DynamoDB Table | `zapier-triggers-events-{stackName}` | `zapier-triggers-events-amplify-dmmfqlsr845yz-dev-branch-*` |
| Lambda Function (API) | Auto-generated by CDK | `amplify-dmmfqlsr845yz-dev-TriggersApiFunction*` |
| Lambda Function (Dispatcher) | Auto-generated by CDK | `amplify-dmmfqlsr845yz-dev-DispatcherFunction*` |
| Secrets Manager | `zapier-api-credentials-{stackName}` | `zapier-api-credentials-amplify-dmmfqlsr845yz-dev-branch-*` |
| Function URL | Unique per environment | `https://*.lambda-url.us-east-2.on.aws/` |
| CloudWatch Logs | `/aws/lambda/{functionName}` | Environment-specific |

## Development Environment

### Purpose

The development environment is for:
- Feature development and integration testing
- Testing breaking changes
- Load and performance testing
- Pre-production validation

### Accessing Development

#### 1. Get the Development API URL

```bash
# List CloudFormation stacks for dev
aws cloudformation list-stacks \
  --region us-east-2 \
  --stack-status-filter CREATE_COMPLETE UPDATE_COMPLETE \
  --query 'StackSummaries[?contains(StackName, `dev-branch`)]' \
  --output table

# Get the API URL from stack outputs
aws cloudformation describe-stacks \
  --region us-east-2 \
  --stack-name amplify-dmmfqlsr845yz-dev-branch-* \
  --query 'Stacks[0].Outputs[?OutputKey==`TriggersApiUrl`].OutputValue' \
  --output text
```

Alternatively, via AWS Console:
1. Go to AWS Amplify Console
2. Select the "apier" app
3. Click on "dev" branch
4. Go to "Backend resources" tab
5. Look for "TriggersApiUrl" in the outputs

#### 2. Configure Development Credentials

The dev environment has its own API credentials:

```bash
# Get the secret ARN
SECRET_ARN=$(aws cloudformation describe-stacks \
  --region us-east-2 \
  --stack-name amplify-dmmfqlsr845yz-dev-branch-* \
  --query 'Stacks[0].Outputs[?OutputKey==`ApiSecretArn`].OutputValue' \
  --output text)

# View current credentials
aws secretsmanager get-secret-value \
  --region us-east-2 \
  --secret-id $SECRET_ARN \
  --query SecretString \
  --output text | jq

# Update dev credentials (use test credentials)
aws secretsmanager update-secret \
  --region us-east-2 \
  --secret-id $SECRET_ARN \
  --secret-string '{
    "zapier_api_key": "dev-test-key-12345",
    "zapier_webhook_url": "https://hooks.zapier.com/hooks/catch/dev/test",
    "jwt_secret": "auto-generated-do-not-change",
    "environment": "development"
  }'
```

#### 3. Test the Development API

```bash
# Set dev API URL
export DEV_API_URL="https://YOUR_DEV_FUNCTION_URL"

# Get JWT token
export TOKEN=$(curl -s -X POST "$DEV_API_URL/token" \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "username=api&password=dev-test-key-12345" | jq -r '.access_token')

# Send a test event
curl -X POST "$DEV_API_URL/events" \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "type": "test.event",
    "source": "dev-test",
    "payload": {
      "message": "Testing development environment",
      "timestamp": "'$(date -u +"%Y-%m-%dT%H:%M:%SZ")'"
    }
  }'

# Check inbox
curl -X GET "$DEV_API_URL/inbox" \
  -H "Authorization: Bearer $TOKEN" | jq

# Health check
curl -X GET "$DEV_API_URL/health" | jq
```

## Production Environment

### Purpose

The production environment serves:
- Live customer traffic
- Real webhook deliveries to Zapier
- Production monitoring and alerting

### Accessing Production

Follow the same steps as development, but use `main` instead of `dev-branch` in queries.

**Security Note**: Production credentials should never be used in development or testing.

## Deployment Workflow

### Development → Production

The standard workflow for deploying changes:

```bash
# 1. Develop and test on dev branch
git checkout dev
git add .
git commit -m "feat: new feature"
git push origin dev
# Wait for dev deployment to complete and test thoroughly

# 2. Merge to main when ready for production
git checkout main
git merge dev
git push origin main
# Triggers automatic production deployment
```

### Automatic Deployments

Both environments auto-deploy when changes are pushed to their respective branches:

```bash
# Deploy to development
git checkout dev
git push origin dev

# Deploy to production
git checkout main
git push origin main
```

### Manual Deployments

To manually trigger a deployment:

```bash
# Development
aws amplify start-job \
  --app-id dmmfqlsr845yz \
  --branch-name dev \
  --job-type RELEASE \
  --region us-east-2

# Production
aws amplify start-job \
  --app-id dmmfqlsr845yz \
  --branch-name main \
  --job-type RELEASE \
  --region us-east-2
```

### Monitoring Deployments

```bash
# Check deployment status
aws amplify list-jobs \
  --app-id dmmfqlsr845yz \
  --branch-name dev \
  --region us-east-2 \
  --max-results 5

# Get detailed job information
aws amplify get-job \
  --app-id dmmfqlsr845yz \
  --branch-name dev \
  --job-id 1 \
  --region us-east-2
```

Or via AWS Console:
1. AWS Amplify Console → apier app → branch
2. View build logs and deployment status

## Environment Comparison

| Aspect | Development | Production |
|--------|-------------|------------|
| **Purpose** | Testing, development | Live customer traffic |
| **Data** | Test data only | Real customer data |
| **Credentials** | Test API keys | Production API keys |
| **Monitoring** | Development alarms | Production alarms (stricter) |
| **Rate Limits** | Standard Lambda limits | Standard Lambda limits |
| **Cost** | AWS charges apply | AWS charges apply |
| **Uptime SLA** | None | High availability |

## Key Features by Environment

### Data Isolation
- Each environment has its own DynamoDB table
- No cross-environment data access
- Safe to test destructive operations in dev

### Credentials
- Separate API keys per environment
- Separate webhook URLs
- Environment-specific secrets in Secrets Manager

### Monitoring
- Separate CloudWatch logs per environment
- Separate alarm configurations
- Independent CloudWatch Dashboards

### Infrastructure
- Identical infrastructure code (same backend.ts)
- Same Lambda configurations
- Same DynamoDB schema

## Using Development Environment

### Frontend Development

Update your frontend environment variables to point to dev:

```bash
# frontend/.env.development
VITE_API_URL=https://YOUR_DEV_FUNCTION_URL
VITE_ENVIRONMENT=development
```

### Integration Testing

Use dev for integration tests that require a live API:

```bash
# Run integration tests against dev
export API_URL=$DEV_API_URL
export API_KEY=dev-test-key-12345
npm run test:integration
```

### Load Testing

Development environment is ideal for:
- Performance testing
- Load testing (won't affect production)
- Breaking change experiments
- Third-party integration testing

## Troubleshooting

### Deployment Failures

1. **Check build logs** in AWS Amplify Console
2. **Verify infrastructure code** in amplify/backend.ts
3. **Check CloudFormation events** for stack errors

```bash
# Get CloudFormation stack events
aws cloudformation describe-stack-events \
  --region us-east-2 \
  --stack-name amplify-dmmfqlsr845yz-dev-branch-* \
  --max-items 20
```

Common issues:
- Resource name length limits (EventBridge rules: 64 chars)
- Missing dependencies in requirements.txt
- TypeScript compilation errors

### Lambda Function Errors

Check CloudWatch Logs:

```bash
# List log groups for dev
aws logs describe-log-groups \
  --region us-east-2 \
  --log-group-name-prefix /aws/lambda/amplify-dmmfqlsr845yz-dev

# Tail logs
aws logs tail /aws/lambda/YOUR_DEV_FUNCTION_NAME \
  --region us-east-2 \
  --follow
```

### API Not Responding

1. Verify Function URL is correct
2. Check Lambda function is deployed
3. Verify secrets are configured
4. Check DynamoDB table exists
5. Review recent CloudFormation deployments

## Cost Considerations

Both environments incur AWS costs:

- **Lambda**: Pay per request ($0.20 per 1M requests)
- **DynamoDB**: On-demand pricing
- **Secrets Manager**: $0.40/month per secret
- **CloudWatch**: Log storage and metrics

**Recommendation**: Development environment runs 24/7 for continuous testing. Costs are minimal for low-traffic testing.

## Security Best Practices

1. **Use Test Credentials**: Never use production API keys in development
2. **Separate Webhook URLs**: Use test Zapier webhooks for dev
3. **Monitor Access**: Review CloudWatch logs regularly
4. **Rotate Secrets**: Change API keys periodically
5. **Limit Access**: Use IAM policies to restrict environment access
6. **Branch Protection**: Require pull requests for main branch

## Related Documentation

- [README.md](../README.md) - Main project documentation
- [DEPLOYMENT.md](./DEPLOYMENT.md) - CI/CD and deployment guide
- [QUICKSTART.md](./QUICKSTART.md) - API quickstart guide
- [SECURITY.md](./SECURITY.md) - Security best practices
- [MONITORING.md](./MONITORING.md) - Monitoring and alerting
- [MANUAL_TESTING_GUIDE.md](../MANUAL_TESTING_GUIDE.md) - Manual testing procedures

## Support

For environment issues:

1. Check this documentation
2. Review AWS Amplify Console logs
3. Check CloudFormation stack status
4. Review Lambda function logs in CloudWatch
5. Verify branch configuration in git

## Changelog

- **2025-11-14**: Simplified to dev → production workflow
  - Removed sandbox environment
  - Cleaned up unused Lambda functions and secrets
  - Updated all documentation
- **2025-11-13**: Initial multi-environment setup
  - Created dev, sandbox, and main environments
  - Configured AWS Amplify deployments
