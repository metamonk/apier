# Deployment Guide

This guide covers setting up and managing the multi-environment CI/CD pipeline for the Zapier Triggers API.

## Quick Start

### For First-Time Setup

1. **AWS Amplify Console Setup**:
   ```bash
   # Open AWS Amplify Console
   open https://console.aws.amazon.com/amplify/
   ```

2. **Connect Repository**:
   - Click "New app" → "Host web app"
   - Select "GitHub" as provider
   - Authorize and select repository: `metamonk/apier`
   - Choose branches to deploy

3. **Configure Environments**:
   - **Production**: Connect `main` branch
   - **Development**: Connect `dev` branch
   - Amplify will auto-detect `amplify.yml` build settings

4. **Verify Build Settings**:
   The `amplify.yml` file is pre-configured with:
   - Backend deployment via `npx ampx pipeline-deploy`
   - Dependency caching for faster builds
   - Environment-specific resource isolation

## Environment Configuration

### Development Environment (`dev` branch)

**Purpose**: Active development, testing, and integration

**Workflow**:
```bash
# Switch to dev branch
git checkout dev

# Make your changes
# ... edit files ...

# Commit and push
git add .
git commit -m "feat: your feature description"
git push origin dev
```

**What Happens**:
1. GitHub triggers webhook to AWS Amplify
2. Amplify pulls latest `dev` branch code
3. Runs build commands from `amplify.yml`
4. Deploys backend resources with `-dev` environment suffix
5. Outputs unique API endpoints for dev environment

### Production Environment (`main` branch)

**Purpose**: Stable, production-ready releases

**Workflow**:
```bash
# After testing in dev, merge to main
git checkout main
git merge dev

# Push to trigger production deployment
git push origin main
```

**What Happens**:
1. GitHub triggers webhook to AWS Amplify
2. Amplify pulls latest `main` branch code
3. Runs build commands from `amplify.yml`
4. Deploys backend resources with `-prod` environment suffix
5. Outputs production API endpoints

## Deployment Process Details

### Amplify Build Phases

The `amplify.yml` file defines three phases:

1. **Backend Build**:
   ```yaml
   backend:
     phases:
       build:
         commands:
           - npm ci --cache .npm --prefer-offline
           - npx ampx pipeline-deploy --branch $AWS_BRANCH --app-id $AWS_APP_ID
   ```
   - Installs dependencies with caching
   - Deploys backend via Amplify Gen 2 pipeline
   - Uses branch name to determine environment

2. **Frontend Pre-Build**:
   ```yaml
   frontend:
     phases:
       preBuild:
         commands:
           - npm ci --cache .npm --prefer-offline
   ```
   - Installs dependencies for any frontend builds
   - Currently minimal since this is backend-only

3. **Frontend Build**:
   ```yaml
   frontend:
     phases:
       build:
         commands:
           - echo "No frontend build required - backend only deployment"
   ```
   - Placeholder for future frontend integration

### Environment Variables

Amplify automatically provides:
- `AWS_BRANCH` - Current branch name (main/dev)
- `AWS_APP_ID` - Amplify app identifier
- `AWS_REGION` - Deployment region

These are used by `ampx pipeline-deploy` to create environment-specific resources.

## Resource Naming Convention

Each environment gets isolated AWS resources with auto-generated names:

### Development (`dev` branch):
- DynamoDB: `zapier-triggers-events-{dev-stack-id}`
- Secret: `zapier-api-credentials-{dev-stack-id}`
- Lambda: Auto-generated by CDK

### Production (`main` branch):
- DynamoDB: `zapier-triggers-events-{prod-stack-id}`
- Secret: `zapier-api-credentials-{prod-stack-id}`
- Lambda: Auto-generated by CDK

## Post-Deployment Tasks

### 1. Get API Endpoints

After each deployment:

```bash
# Via Amplify Console
# → App → Branch → Backend resources → Click "TriggersApiUrl"

# Or via AWS CLI
aws cloudformation describe-stacks \
  --stack-name {stack-name} \
  --query 'Stacks[0].Outputs[?OutputKey==`TriggersApiUrl`].OutputValue' \
  --output text
```

### 2. Configure Secrets

Update environment-specific secrets:

```bash
# Get stack name from Amplify Console or CloudFormation
STACK_NAME="your-stack-name"

# Update secrets
aws secretsmanager update-secret \
  --secret-id zapier-api-credentials-${STACK_NAME} \
  --secret-string '{
    "zapier_api_key": "your-actual-api-key",
    "zapier_webhook_url": "https://hooks.zapier.com/your-webhook",
    "jwt_secret": "keep-auto-generated-value",
    "environment": "production"
  }'
```

### 3. Test API

```bash
# Get the Function URL from Amplify Console
API_URL="your-function-url"

# Health check
curl $API_URL

# View API docs
open ${API_URL}docs
```

## Monitoring Deployments

### Amplify Console

1. **Build Status**:
   - Go to Amplify Console → App → Branch
   - View real-time build logs
   - Check for errors in each phase

2. **Backend Resources**:
   - Click "Backend resources" tab
   - View all deployed CloudFormation stacks
   - Access output values (API URLs, ARNs)

### CloudFormation

Each deployment creates/updates a CloudFormation stack:

```bash
# List stacks
aws cloudformation list-stacks \
  --stack-status-filter CREATE_COMPLETE UPDATE_COMPLETE

# View stack events
aws cloudformation describe-stack-events \
  --stack-name {stack-name} \
  --max-items 20
```

### CloudWatch Logs

Monitor Lambda function logs:

```bash
# Find log group
aws logs describe-log-groups \
  --log-group-name-prefix /aws/lambda/

# Tail logs
aws logs tail /aws/lambda/{function-name} --follow
```

## Troubleshooting

### Build Failures

**Problem**: Amplify build fails with "npm install" errors

**Solution**:
```bash
# Verify package.json has all dependencies
npm install
npm test

# Check amplify.yml syntax
cat amplify.yml

# Review build logs in Amplify Console
```

### Deployment Timeouts

**Problem**: CloudFormation stack creation times out

**Solution**:
- Check AWS service quotas (Lambda, DynamoDB)
- Verify IAM permissions for Amplify service role
- Review CloudFormation events for specific resource failures

### Environment Mismatch

**Problem**: Changes don't appear in expected environment

**Solution**:
```bash
# Verify current branch
git branch

# Verify remote tracking
git remote -v
git branch -vv

# Force rebuild in Amplify Console
# → App → Branch → "Redeploy this version"
```

### Docker Build Failures

**Problem**: Lambda Docker image fails to build

**Solution**:
```bash
# Test Docker build locally
cd amplify/functions/api
docker build --platform linux/amd64 -t test-api .

# Verify Dockerfile
cat Dockerfile

# Check logs in Amplify Console build phase
```

## Rollback Procedures

### Quick Rollback via Amplify

1. Go to Amplify Console → App → Branch
2. View build history
3. Click on previous successful build
4. Click "Redeploy this version"

### Manual Rollback via Git

```bash
# Development rollback
git checkout dev
git reset --hard {previous-commit-sha}
git push --force origin dev

# Production rollback
git checkout main
git reset --hard {previous-commit-sha}
git push --force origin main
```

**⚠️ Warning**: Force pushing to `main` should be rare. Use with caution.

### CloudFormation Rollback

If deployment fails, CloudFormation automatically rolls back:
- View rollback events in CloudFormation Console
- Previous stack state is restored
- Resources are reverted to last stable version

## Best Practices

### Development Workflow

1. ✅ **Always develop on `dev` branch first**
2. ✅ **Test in dev environment before merging to main**
3. ✅ **Use feature branches for complex changes**
4. ✅ **Squash commits when merging to keep history clean**

### Deployment Strategy

1. ✅ **Review build logs for each deployment**
2. ✅ **Test API endpoints immediately after deployment**
3. ✅ **Update secrets after first deployment**
4. ✅ **Monitor CloudWatch logs for errors**

### Security

1. ✅ **Never commit secrets to Git**
2. ✅ **Use AWS Secrets Manager for credentials**
3. ✅ **Review IAM permissions regularly**
4. ✅ **Enable MFA for AWS Console access**

## CI/CD Pipeline Diagram

```
Developer                    GitHub                     AWS Amplify                   AWS Resources
    |                          |                            |                              |
    |-- git push dev -------->|                            |                              |
    |                          |-- webhook --------------->|                              |
    |                          |                            |-- Build (amplify.yml) ----->|
    |                          |                            |                              |
    |                          |                            |<-- Build Complete ----------|
    |                          |                            |                              |
    |                          |                            |-- Deploy Backend ---------->|
    |                          |                            |                              |-- Create/Update:
    |                          |                            |                              |   - Lambda
    |                          |                            |                              |   - DynamoDB
    |                          |                            |                              |   - Secrets Manager
    |                          |                            |                              |
    |                          |                            |<-- Deploy Complete ---------|
    |                          |                            |                              |
    |<-- Notification ---------|<-- Webhook ----------------|                              |
    |                          |                            |                              |
```

## Maintenance

### Regular Tasks

- **Weekly**: Review CloudWatch logs for errors
- **Monthly**: Audit IAM permissions and secrets
- **Quarterly**: Review and update dependencies
- **Yearly**: Evaluate new AWS services and features

### Cost Optimization

- Monitor AWS Cost Explorer for resource usage
- Consider Reserved Capacity for DynamoDB if usage is predictable
- Use Lambda provisioned concurrency only if cold starts are an issue
- Enable DynamoDB auto-scaling if traffic patterns vary

## Support

For issues or questions:
1. Check AWS Amplify Console build logs
2. Review CloudFormation stack events
3. Check CloudWatch logs for Lambda errors
4. Consult AWS Amplify documentation: https://docs.amplify.aws

## Next Steps

After completing initial setup:
1. Deploy to `dev` branch first to test pipeline
2. Verify dev environment resources in AWS Console
3. Update secrets for dev environment
4. Test API endpoints in dev
5. Merge to `main` and deploy production
6. Configure monitoring and alerts
