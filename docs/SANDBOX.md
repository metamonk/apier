# Sandbox Environment Guide

## Overview

The sandbox environment is a live, isolated AWS environment that mirrors the production setup. It allows developers to test API integrations, workflows, and changes without affecting production data or users.

## Architecture

The sandbox environment uses AWS Amplify Gen 2's branch-based deployment strategy:

- **Branch**: `sandbox`
- **Stage**: `DEVELOPMENT`
- **Amplify App ID**: `dmmfqlsr845yz`
- **Region**: `us-east-2` (US East - Ohio)

### Resource Isolation

Each environment (production/main, dev, sandbox) gets its own isolated AWS resources:

| Resource | Naming Pattern | Sandbox Example |
|----------|---------------|-----------------|
| DynamoDB Table | `zapier-triggers-events-{stackName}` | `zapier-triggers-events-amplify-dmmfqlsr845yz-sandbox-branch-*` |
| Lambda Function | Auto-generated by CDK | `amplify-dmmfqlsr845yz-sandbox-*` |
| Secrets Manager | `zapier-api-credentials-{stackName}` | `zapier-api-credentials-amplify-dmmfqlsr845yz-sandbox-branch-*` |
| Function URL | Unique per environment | `https://*.lambda-url.us-east-2.on.aws/` |
| CloudWatch Logs | `/aws/lambda/{functionName}` | Environment-specific |

## Accessing the Sandbox

### 1. Get the Sandbox API URL

After deployment, retrieve the sandbox Function URL:

```bash
# List CloudFormation stacks for sandbox
aws cloudformation list-stacks \
  --region us-east-2 \
  --stack-status-filter CREATE_COMPLETE UPDATE_COMPLETE \
  --query 'StackSummaries[?contains(StackName, `sandbox`)]' \
  --output table

# Get the API URL from stack outputs
aws cloudformation describe-stacks \
  --region us-east-2 \
  --stack-name amplify-dmmfqlsr845yz-sandbox-branch-* \
  --query 'Stacks[0].Outputs[?OutputKey==`TriggersApiUrl`].OutputValue' \
  --output text
```

Alternatively, find it in the AWS Console:
1. Go to AWS Amplify Console
2. Select the "apier" app
3. Click on "sandbox" branch
4. Go to "Backend resources" tab
5. Look for "TriggersApiUrl" in the outputs

### 2. Configure Sandbox Credentials

The sandbox has its own set of API credentials stored in AWS Secrets Manager:

```bash
# Get the secret name
SECRET_NAME=$(aws cloudformation describe-stacks \
  --region us-east-2 \
  --stack-name amplify-dmmfqlsr845yz-sandbox-branch-* \
  --query 'Stacks[0].Outputs[?OutputKey==`ApiSecretArn`].OutputValue' \
  --output text | awk -F: '{print $NF}')

# View current credentials
aws secretsmanager get-secret-value \
  --region us-east-2 \
  --secret-id $SECRET_NAME \
  --query SecretString \
  --output text | jq

# Update sandbox credentials (use test credentials)
aws secretsmanager update-secret \
  --region us-east-2 \
  --secret-id $SECRET_NAME \
  --secret-string '{
    "zapier_api_key": "sandbox-test-key-12345",
    "zapier_webhook_url": "https://hooks.zapier.com/hooks/catch/sandbox/test",
    "jwt_secret": "auto-generated-do-not-change",
    "environment": "sandbox"
  }'
```

### 3. Test the Sandbox API

```bash
# Set sandbox API URL
export SANDBOX_API_URL="https://YOUR_SANDBOX_FUNCTION_URL"

# Get JWT token
export TOKEN=$(curl -s -X POST "$SANDBOX_API_URL/token" \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "username=api&password=sandbox-test-key-12345" | jq -r '.access_token')

# Send a test event
curl -X POST "$SANDBOX_API_URL/events" \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "type": "test.event",
    "source": "sandbox-test",
    "payload": {
      "message": "Testing sandbox environment",
      "timestamp": "2025-11-13T15:30:00Z"
    }
  }'

# Check inbox
curl -X GET "$SANDBOX_API_URL/inbox" \
  -H "Authorization: Bearer $TOKEN" | jq

# Health check
curl -X GET "$SANDBOX_API_URL/health" | jq
```

## Deployment Workflow

### Automatic Deployments

The sandbox environment auto-deploys when changes are pushed to the `sandbox` branch:

```bash
# Switch to sandbox branch
git checkout sandbox

# Make changes and commit
git add .
git commit -m "feat: test new feature in sandbox"
git push origin sandbox
```

This triggers an automatic deployment via AWS Amplify Console.

### Manual Deployments

To manually trigger a deployment:

```bash
aws amplify start-job \
  --app-id dmmfqlsr845yz \
  --branch-name sandbox \
  --job-type RELEASE \
  --region us-east-2
```

### Monitoring Deployment

```bash
# Check deployment status
aws amplify list-jobs \
  --app-id dmmfqlsr845yz \
  --branch-name sandbox \
  --region us-east-2 \
  --max-results 5

# Get detailed job information
aws amplify get-job \
  --app-id dmmfqlsr845yz \
  --branch-name sandbox \
  --job-id 1 \
  --region us-east-2
```

Or via AWS Console:
1. AWS Amplify Console → apier app → sandbox branch
2. View build logs and deployment status

## Branch Strategy

```
main (production) ← stable, production-ready code
  │
  ├── dev (development) ← active development, testing
  │
  └── sandbox (sandbox) ← isolated testing, demos, experiments
```

### When to Use Each Environment

| Environment | Purpose | Data | Use Case |
|-------------|---------|------|----------|
| **Production (main)** | Live users | Real data | Customer-facing API |
| **Development (dev)** | Active development | Test data | Feature development, integration testing |
| **Sandbox (sandbox)** | Isolated testing | Isolated test data | Demos, experiments, third-party integrations |

## Key Differences from Production

### 1. Data Isolation
- Sandbox has its own DynamoDB table
- No access to production data
- Safe to test destructive operations

### 2. Credentials
- Separate API keys (use test keys, not production)
- Separate webhook URLs
- Environment-specific secrets

### 3. Monitoring
- Separate CloudWatch logs
- Separate alarms (can be less strict)
- Own CloudWatch Dashboard

### 4. Rate Limits
- Same AWS Lambda limits as production
- Can configure different throttling if needed

## Using Sandbox for Development

### Frontend Development

Update your frontend environment variables to point to sandbox:

```bash
# frontend/.env.sandbox
VITE_API_URL=https://YOUR_SANDBOX_FUNCTION_URL
VITE_ENVIRONMENT=sandbox
```

### Integration Testing

Use sandbox for integration tests that require a live API:

```bash
# Run integration tests against sandbox
export API_URL=$SANDBOX_API_URL
export API_KEY=sandbox-test-key-12345
npm run test:integration
```

### Demo Scenarios

Sandbox is perfect for:
- Customer demos (isolated from production)
- Third-party integration testing
- Load testing (won't affect production)
- Breaking change experiments

## Troubleshooting

### Deployment Failures

1. **Check build logs** in AWS Amplify Console
2. **Verify branch configuration** matches main branch
3. **Check CloudFormation events** for stack errors

```bash
# Get CloudFormation stack events
aws cloudformation describe-stack-events \
  --region us-east-2 \
  --stack-name amplify-dmmfqlsr845yz-sandbox-branch-* \
  --max-items 20
```

### Lambda Function Errors

Check CloudWatch Logs:

```bash
# List log groups for sandbox
aws logs describe-log-groups \
  --region us-east-2 \
  --log-group-name-prefix /aws/lambda/amplify-dmmfqlsr845yz-sandbox

# Tail logs
aws logs tail /aws/lambda/YOUR_SANDBOX_FUNCTION_NAME \
  --region us-east-2 \
  --follow
```

### API Not Responding

1. Verify Function URL is correct
2. Check Lambda function is deployed
3. Verify secrets are configured
4. Check DynamoDB table exists

## Cost Considerations

The sandbox environment incurs AWS costs similar to production:

- **Lambda**: Pay per request ($0.20 per 1M requests)
- **DynamoDB**: On-demand pricing (Pay per read/write)
- **Secrets Manager**: $0.40/month per secret
- **CloudWatch**: Log storage and metrics

**Recommendation**: Delete sandbox when not in use for extended periods (can redeploy anytime from git).

### Deleting Sandbox

To remove sandbox and stop costs:

```bash
# Delete Amplify branch (preserves git branch)
aws amplify delete-branch \
  --app-id dmmfqlsr845yz \
  --branch-name sandbox \
  --region us-east-2
```

The git branch remains, so you can redeploy anytime.

## Security Best Practices

1. **Use Test Credentials**: Never use production API keys in sandbox
2. **Separate Webhook URLs**: Use test Zapier webhooks
3. **Monitor Access**: Review CloudWatch logs regularly
4. **Rotate Secrets**: Change sandbox API keys periodically
5. **Limit Access**: Use IAM policies to restrict who can access sandbox

## Related Documentation

- [README.md](../README.md) - Main project documentation
- [DEPLOYMENT.md](./DEPLOYMENT.md) - CI/CD and deployment guide
- [QUICKSTART.md](./QUICKSTART.md) - API quickstart guide
- [SECURITY.md](./SECURITY.md) - Security best practices
- [MONITORING.md](./MONITORING.md) - Monitoring and alerting

## Support

For issues with the sandbox environment:

1. Check this documentation
2. Review AWS Amplify Console logs
3. Check CloudFormation stack status
4. Review Lambda function logs in CloudWatch

## Changelog

- **2025-11-13**: Initial sandbox environment setup
  - Created `sandbox` branch
  - Configured AWS Amplify deployment
  - Documented access procedures
